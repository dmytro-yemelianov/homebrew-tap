name: Update Formula

on:
  repository_dispatch:
    types: [raps-release]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update to (e.g., 2.0.0)'
        required: true

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          # Remove 'v' prefix if present
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸŒ¼ Updating to RAPS v$VERSION"

      - name: Download checksums
        id: checksums
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BASE_URL="https://github.com/dmytro-yemelianov/raps/releases/download/v${VERSION}"

          # Download cargo-dist assets (tar.xz format)
          curl -fsSL "${BASE_URL}/raps-cli-x86_64-apple-darwin.tar.xz" -o macos-x64.tar.xz
          curl -fsSL "${BASE_URL}/raps-cli-aarch64-apple-darwin.tar.xz" -o macos-arm64.tar.xz
          curl -fsSL "${BASE_URL}/raps-cli-x86_64-unknown-linux-gnu.tar.xz" -o linux-x64.tar.xz
          curl -fsSL "${BASE_URL}/raps-cli-aarch64-unknown-linux-gnu.tar.xz" -o linux-arm64.tar.xz

          echo "macos_x64=$(sha256sum macos-x64.tar.xz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "macos_arm64=$(sha256sum macos-arm64.tar.xz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "linux_x64=$(sha256sum linux-x64.tar.xz | cut -d' ' -f1)" >> $GITHUB_OUTPUT
          echo "linux_arm64=$(sha256sum linux-arm64.tar.xz | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Update formula
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          cat > Formula/raps.rb << 'EOF'
          class Raps < Formula
            desc "ðŸŒ¼ RAPS (rapeseed) â€” Rust Autodesk Platform Services CLI"
            homepage "https://rapscli.xyz"
            version "${{ steps.version.outputs.version }}"
            license "Apache-2.0"

            on_macos do
              if Hardware::CPU.intel?
                url "https://github.com/dmytro-yemelianov/raps/releases/download/v#{version}/raps-cli-x86_64-apple-darwin.tar.xz"
                sha256 "${{ steps.checksums.outputs.macos_x64 }}"
              else
                url "https://github.com/dmytro-yemelianov/raps/releases/download/v#{version}/raps-cli-aarch64-apple-darwin.tar.xz"
                sha256 "${{ steps.checksums.outputs.macos_arm64 }}"
              end
            end

            on_linux do
              if Hardware::CPU.intel?
                url "https://github.com/dmytro-yemelianov/raps/releases/download/v#{version}/raps-cli-x86_64-unknown-linux-gnu.tar.xz"
                sha256 "${{ steps.checksums.outputs.linux_x64 }}"
              else
                url "https://github.com/dmytro-yemelianov/raps/releases/download/v#{version}/raps-cli-aarch64-unknown-linux-gnu.tar.xz"
                sha256 "${{ steps.checksums.outputs.linux_arm64 }}"
              end
            end

            def install
              bin.install "raps-cli" => "raps"
            end

            test do
              system "#{bin}/raps --version"
            end
          end
          EOF

      - name: Commit and push
        id: commit
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/raps.rb

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit - already at v${VERSION}"
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            git commit -m "Update to v${VERSION}"
            git push
            echo "updated=true" >> $GITHUB_OUTPUT
          fi

      - name: Summary
        run: |
          echo "## ðŸŒ¼ Homebrew Formula Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **macOS x64:** \`${{ steps.checksums.outputs.macos_x64 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **macOS arm64:** \`${{ steps.checksums.outputs.macos_arm64 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Linux x64:** \`${{ steps.checksums.outputs.linux_x64 }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Linux arm64:** \`${{ steps.checksums.outputs.linux_arm64 }}\`" >> $GITHUB_STEP_SUMMARY

  # Test Homebrew installation after formula update
  test-homebrew:
    name: Test Homebrew Installation (${{ matrix.os }})
    needs: update
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, ubuntu-latest]
    steps:
      - name: Install Homebrew (Linux)
        if: runner.os == 'Linux'
        run: |
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH

      - name: Add tap and install raps
        run: |
          brew tap dmytro-yemelianov/tap
          brew install raps

      - name: Verify installation
        run: |
          echo "ðŸ§ª Testing raps --version..."
          raps --version

          echo "ðŸ§ª Testing raps --help..."
          raps --help

          echo "âœ… Homebrew installation test passed on ${{ matrix.os }}"

      - name: Test upgrade path
        run: |
          echo "ðŸ”„ Testing brew upgrade..."
          brew upgrade raps || echo "Already at latest version"
          raps --version
          echo "âœ… Upgrade test passed"
